/*
 * Copyright (c) 2009 Zenoss, Inc.
 * 
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * version 2 as published by the Free Software Foundation.
 * 
 * For complete information please visit http://www.zenoss.com/oss/
 */
Ext.onReady(function(){Ext.namespace("Zenoss");Ext.namespace("Zenoss.env");Ext.QuickTips.init();Ext.Direct.on("event",function(a){try{if(a.status){YAHOO.zenoss.Messenger.clearConnectionErrors()}else{YAHOO.zenoss.Messenger.connectionError()}}catch(a){Ext.emptyFn()}Zenoss.env.asof=a.asof||null});_oldGetCallData=Ext.direct.RemotingProvider.prototype.getCallData;Ext.override(Ext.direct.RemotingProvider,{getCallData:function(a){return Ext.apply(_oldGetCallData.apply(this,arguments),{asof:Zenoss.env.asof})}});Zenoss.PlaceholderPanel=Ext.extend(Ext.Panel,{constructor:function(a){Ext.apply(a,{cls:"placeholder",layout:"fit",border:false,items:[{baseCls:"inner",border:false,html:a.text,listeners:{resize:function(b){b.getEl().setStyle({"line-height":b.getEl().getComputedHeight()+"px"})}}}]});Zenoss.PlaceholderPanel.superclass.constructor.apply(this,arguments)}});Zenoss.LargeToolbar=Ext.extend(Ext.Toolbar,{constructor:function(a){Ext.apply(a,{cls:"largetoolbar",height:45,border:false});Zenoss.LargeToolbar.superclass.constructor.apply(this,arguments)}});Zenoss.ExtraHooksSelectionModel=Ext.extend(Ext.ux.grid.livegrid.RowSelectionModel,{initEvents:function(){Zenoss.ExtraHooksSelectionModel.superclass.initEvents.call(this);this.addEvents("rangeselect")},selectRange:function(b,a,d){this.suspendEvents();Zenoss.ExtraHooksSelectionModel.superclass.selectRange.apply(this,arguments);this.resumeEvents();this.fireEvent("rangeselect",this)}});Zenoss.PostRefreshHookableDataView=Ext.extend(Ext.DataView,{constructor:function(a){Zenoss.PostRefreshHookableDataView.superclass.constructor.apply(this,arguments);this.addEvents("afterrefresh")}});Ext.extend(Zenoss.PostRefreshHookableDataView,Ext.DataView,{refresh:function(){this.clearSelections(false,true);this.el.update("");var a=this.store.getRange();if(a.length<1){if(!this.deferEmptyText||this.hasSkippedEmptyText){this.el.update(this.emptyText)}this.hasSkippedEmptyText=true;this.all.clear();return}this.tpl.overwrite(this.el,this.collectData(a,0));this.fireEvent("afterrefresh",this);this.all.fill(Ext.query(this.itemSelector,this.el.dom));this.updateIndexes(0)}});Zenoss.LiveGridInfoPanel=Ext.extend(Ext.Toolbar.TextItem,{displayMsg:"Displaying {0} - {1} of {2} events",emptyMsg:"No events",cls:"livegridinfopanel",initComponent:function(){this.setText(this.emptyMsg);if(this.grid){this.grid=Ext.getCmp(this.grid);var a=this;this.view=this.grid.getView();this.view.init=this.view.init.createSequence(function(){a.bind(this)},this.view)}Zenoss.LiveGridInfoPanel.superclass.initComponent.call(this)},updateInfo:function(e,d,a){var b=a==0?this.emptyMsg:String.format(this.displayMsg,e+1,e+d,a);this.setText(b)},bind:function(a){this.view=a;var b=a.ds;a.on("rowremoved",this.onRowRemoved,this);a.on("rowsinserted",this.onRowsInserted,this);a.on("beforebuffer",this.beforeBuffer,this);a.on("cursormove",this.onCursorMove,this);a.on("buffer",this.onBuffer,this)},onCursorMove:function(b,e,d,a){this.updateInfo(e,d,a)},onRowsInserted:function(b,d,a){this.updateInfo(b.rowIndex,Math.min(b.ds.totalLength,b.visibleRows-b.rowClipped),b.ds.totalLength)},onRowRemoved:function(b,d,a){this.updateInfo(b.rowIndex,Math.min(b.ds.totalLength,b.visibleRows-b.rowClipped),b.ds.totalLength)},beforeBuffer:function(b,d,g,f,a,e){this.updateInfo(g,f,a)},onBuffer:function(b,d,f,e,a){this.updateInfo(f,e,a)}});Ext.reg("livegridinfo",Zenoss.LiveGridInfoPanel);Zenoss.FilterGridView=Ext.extend(Ext.ux.grid.livegrid.GridView,{rowColors:false,constructor:function(a){if(typeof(a.displayFilters)=="undefined"){a.displayFilters=true}Zenoss.FilterGridView.superclass.constructor.apply(this,arguments)},lastOptions:{},initEvents:function(){Zenoss.FilterGridView.superclass.initEvents.call(this);this.addEvents("filterchange");this.addEvents("filtertoggle")},initData:function(d,a){var b=this.grid.store;this.un("beforebuffer",this.onBeforeBuffer,this);a.un("hiddenchange",this.updateHeaders,this);this.on("beforebuffer",this.onBeforeBuffer,this);a.on("hiddenchange",this.updateHeaders,this);Zenoss.FilterGridView.superclass.initData.call(this,d,a)},applyFilterParams:function(a){var e=this.lastOptions||{};for(i=0;i<this.filters.length;i++){var b=this.filters[i];var d;query=b.getValue();if(query){e[b.id]=query;if(b.xtype=="datefield"){dt=new Date(query);query=dt.format(Zenoss.date.UniversalSortableDateTime)}}else{delete e[b.id]}}Ext.apply(a.params,{params:Ext.util.JSON.encode(e)});this.lastOptions=e},onBeforeLoad:function(a,b){this.applyFilterParams(b);return Zenoss.FilterGridView.superclass.onBeforeLoad.call(this,a,b)},onBeforeBuffer:function(b,d,g,f,a,e){this.applyFilterParams(e);return true},getFilterCt:function(){return Ext.select(".x-grid3-filter")},hideFilters:function(){this.setFiltersDisplayed(false)},showFilters:function(){this.setFiltersDisplayed(true)},clearFilters:function(){Ext.each(this.filters,function(a){a.reset()},this);this.updateLiveRows(this.rowIndex,true,true)},setFiltersDisplayed:function(a){a=true;this.displayFilters=a;this.getFilterCt().setDisplayed(a);this.fireEvent("filtertoggle");if(a){this.renderEditors()}this.layout()},renderFilterRow:function(){var f=this.getColumnData(),d=this.templates.cell,d=new Ext.Template('<td class="x-grid3-col x-grid3-cell',' x-grid3-td-{id} {css}" style="{style}" tabIndex="-1"',' {cellAttr}> <div class="x-grid3-cell-inner',' x-grid3-col-{id}" unselectable="on" {attr}>',"{value}</div></td>"),b=[],g={},e={},a=new Ext.Template('<tr {display} class="x-grid3-filter"',">{cells}</tr>");for(i=0,len=f.length;i<len;i++){if(this.cm.isHidden(i)){continue}c=f[i];g.id=c.id;g.css="x-grid3-cell-filter";g.attr='id="filtergrid-'+c.id+'"';g.cellAttr="";g.value="";b[b.length]=d.apply(g)}e.tsyle="width:"+this.getTotalWidth()+";";e.cols=b.length;e.cells=b.join("");e.display="";return a.apply(e)},filters:[],nonDisruptiveReset:function(){this.ds.modified=[];this.rowIndex=0;this.lastScrollPos=0;this.lastRowIndex=0;this.lastIndex=0;this.adjustVisibleRows();this.adjustScrollerPos(-this.liveScroller.dom.scrollTop,true);this.showLoadMask(false);this.updateLiveRows(this.rowIndex,true,true)},renderEditors:function(){Ext.each(this.filters,function(k){k.destroy()});var f=this.getColumnData();for(i=0,len=f.length;i<len;i++){if(this.cm.isHidden(i)){continue}var j=f[i],a=j.id,h="filtergrid-"+a;var d=this.cm.config[i].filter;if(!d){d={xtype:"textfield"}}Ext.apply(d,{id:a,enableKeyEvents:true,selectOnFocus:true});var e=new Ext.ComponentMgr.create(d?d:{xtype:"textfield",validationDelay:500});if(this.lastOptions){var g=this.lastOptions[a];e.setValue(g)}var b=new Ext.Panel({frame:false,border:false,layout:"fit",renderTo:h,items:e});e.setWidth("100%");this.filters[this.filters.length]=e;e.validationTask=new Ext.util.DelayedTask(function(){this.fireEvent("filterchange",this);this.nonDisruptiveReset()},this);if(e.xtype=="textfield"){e.on("keyup",function(l,k){if(!k.isNavKeyPress()){this.validationTask.delay(250)}},e)}else{e.on("select",function(l,k){this.validationTask.delay(250)},e);e.on("change",function(l,k){this.validationTask.delay(250)},e)}}},updateHeaders:function(){Zenoss.FilterGridView.superclass.updateHeaders.call(this);this.renderEditors()},renderUI:function(){Zenoss.FilterGridView.superclass.renderUI.call(this)},renderHeaders:function(){html=Zenoss.FilterGridView.superclass.renderHeaders.call(this);html=html.slice(0,html.length-8);html=html+this.renderFilterRow()+"</table>";return html},getState:function(){return{displayFilters:this.displayFilters,options:this.lastOptions}},getFilterButton:function(){return Ext.getCmp(this.filterbutton)},getRowClass:function(b,d){var e=b.get("eventState")=="New"?"unacknowledged":"acknowledged";var f=Zenoss.util.convertSeverity(b.get("severity"));var a=this.rowColors?f+" rowcolor":"";return e+" "+a},toggleRowColors:function(a){this.rowColors=a;Ext.state.Manager.set("rowcolor",a);this.updateLiveRows(this.rowIndex,true,false)},applyState:function(a){this.displayFilters=true;this.lastOptions=a.options},resetFilters:function(){this.lastOptions={}}});Zenoss.FilterGridPanel=Ext.extend(Ext.ux.grid.livegrid.GridPanel,{initStateEvents:function(){Zenoss.FilterGridPanel.superclass.initStateEvents.call(this);this.mon(this.view,"filterchange",this.saveState,this);this.mon(this.view,"filtertoggle",this.saveState,this)},getView:function(){if(!this.view){this.view=new Zenoss.FilterGridView(this.viewConfig)}return this.view},restoreURLState:function(){var a=window.location.search.replace(/^\?/,""),b=Ext.urlDecode(a).state;if(b){try{b=Ext.decode(Zenoss.util.base64.decode(b));this.applyState(b)}catch(d){noop()}}},clearURLState:function(){var a=window.location.search.replace(/^\?/,""),a=Ext.urlDecode(a);if(a.state){delete a.state;a=Ext.urlEncode(a);if(a){window.location.search="?"+Ext.urlEncode(a)}else{window.location.search=""}}},getPermalink:function(){var a=window.location,b=a.protocol+"//"+a.host+a.pathname;st=Zenoss.util.base64.encode(Ext.encode(this.getState()));return b+"?state="+st},initState:function(){Zenoss.FilterGridPanel.superclass.initState.apply(this,arguments);this.restoreURLState();var a=Ext.state.Manager.get("rowcolor");this.view.rowColors=a;var b=Ext.getCmp(this.view.rowcoloritem);b.on("render",function(){this.setChecked(a)},b)},getState:function(){var b=Zenoss.FilterGridPanel.superclass.getState.call(this);var a=this.getView().getState();b.filters=a;return b},applyState:function(d){var a=Ext.pluck(this.initialConfig.cm.config,"id"),e=[],b={};Ext.each(d.columns,function(f){if(a.indexOf(f.id)>-1){e.push(f)}});Ext.iterate(d.filters.options,function(f){if(a.indexOf(f.id)>-1){b[f.id]=f}});d.columns=e;d.filters.options=b;this.getView().applyState(d.filters);Zenoss.FilterGridPanel.superclass.applyState.apply(this,arguments)},resetGrid:function(){Ext.state.Manager.clear(this.getItemId());var a=this.getView();a.resetFilters();Zenoss.remote.EventConsole.column_config({},function(d){var e=[];Ext.each(d,function(f){e[e.length]=Ext.decode(f)});var b=new Ext.grid.ColumnModel(e);this.store.sortInfo=this.store.defaultSort;this.reconfigure(this.store,b);a.fitColumns();a.showLoadMask(true);a.nonDisruptiveReset();this.saveState();this.clearURLState()},this)},hideFilters:function(){this.getView().hideFilters()},showFilters:function(){this.getView().showFilters()},clearFilters:function(){this.getView().clearFilters()}});Zenoss.MultiselectMenu=Ext.extend(Ext.Toolbar.Button,{constructor:function(a){items=[];var b=this;Ext.each(a.source,function(d){items[items.length]={checked:typeof(d.checked)=="undefined",hideOnClick:false,handler:function(){b.fireEvent("change")},value:d.value,text:d.text}});a.menu={items:items};Zenoss.MultiselectMenu.superclass.constructor.apply(this,arguments)},reset:function(){this.setValue()},getValue:function(){var a=[];Ext.each(this.menu.items.items,function(b){if(b.checked){a[a.length]=b.value}});return a},setValue:function(a){if(!a){this.constructor(this.initialConfig)}else{Ext.each(this.menu.items.items,function(f){var b=false;try{b=a.indexOf(f.value)!=-1}catch(g){var d}f.setChecked(b)})}}});Ext.reg("multiselectmenu",Zenoss.MultiselectMenu);Zenoss.StatefulRefreshMenu=Ext.extend(Ext.menu.Menu,{constructor:function(a){a.stateful=true;a.stateEvents=["itemclick"];Zenoss.StatefulRefreshMenu.superclass.constructor.apply(this,arguments)},getState:function(){return this.trigger.interval},applyState:function(b){var a=this.items.items;Ext.each(a,function(d){if(d.value==b){d.setChecked(true)}},this);this.trigger.on("afterrender",function(){this.trigger.setInterval(b)},this)}});Ext.reg("statefulrefreshmenu",Zenoss.StatefulRefreshMenu);Zenoss.RefreshMenuButton=Ext.extend(Ext.SplitButton,{constructor:function(a){var b={xtype:"statefulrefreshmenu",id:"evc_refresh",trigger:this,items:[{xtype:"menutextitem",cls:"refreshevery",text:"Refresh every"},{xtype:"menucheckitem",text:"1 second",value:1,group:"refreshgroup"},{xtype:"menucheckitem",text:"5 seconds",value:5,group:"refreshgroup"},{xtype:"menucheckitem",text:"10 seconds",value:10,group:"refreshgroup"},{xtype:"menucheckitem",text:"30 seconds",value:30,group:"refreshgroup"},{xtype:"menucheckitem",text:"1 minute",value:60,checked:true,group:"refreshgroup"},{xtype:"menucheckitem",text:"Manually",value:-1,group:"refreshgroup"}]};a.menu=b;Zenoss.RefreshMenuButton.superclass.constructor.apply(this,arguments);this.refreshTask=new Ext.util.DelayedTask(this.poll,this);this.menu.on("itemclick",function(d){this.setInterval(d.value)},this)},setInterval:function(a){this.interval=a;this.refreshTask.delay(this.interval*1000)},poll:function(){if(this.interval>0){this.handler();this.refreshTask.delay(this.interval*1000)}}});Ext.reg("refreshmenu",Zenoss.RefreshMenuButton);Zenoss.DetailPanel=Ext.extend(Ext.Panel,{isHistory:false,constructor:function(a){a.onDetailHide=a.onDetailHide||function(){var b};a.layout="border";a.border=false;a.defaults={border:false};a.items=[{id:"evdetail_hd",region:"north",layout:"border",height:50,cls:"evdetail_hd",defaults:{border:false},items:[{region:"west",width:77,layout:"hbox",defaults:{border:false},items:[{id:"severity-icon",cls:"severity-icon"},{id:"evdetail-sep",cls:"evdetail-sep"}]},{region:"center",id:"evdetail-summary",html:""},{region:"east",id:"evdetail-tools",layout:"hbox",width:57,defaults:{border:false},items:[{id:"evdetail-popout",cls:"evdetail-popout"},{id:"evdetail_tool_close",cls:"evdetail_close"}]}]},{id:"evdetail_bd",region:"center",defaults:{frame:false,border:false},autoScroll:true,layout:"table",layoutConfig:{columns:1,tableAttrs:{style:{width:"90%"}}},cls:"evdetail_bd",items:[{id:"evdetail_props",cls:"evdetail_props",html:""},{id:"show_details",cls:"show_details",hidden:true,html:"Show more details..."},{id:"full_event_props",cls:"full_event_props",hidden:true,html:""},{id:"evdetail-log-header",cls:"evdetail-log-header",hidden:true,html:"<hr/><h2>LOG</h2>"},{xtype:"form",id:"log-container",defaults:{border:false},frame:true,layout:"table",style:{"margin-left":"3em"},hidden:true,labelWidth:1,items:[{id:"detail-logform-evid",xtype:"hidden",name:"evid"},{style:"margin:0.75em",width:300,xtype:"textfield",name:"message",id:"detail-logform-message"},{xtype:"button",type:"submit",name:"add",text:"Add",handler:function(b,g){var d=Ext.getCmp("log-container"),f=d.getForm().getValues();params={history:this.isHistory};Ext.apply(params,f);Zenoss.remote.EventConsole.write_log(params,function(h,e){Ext.getCmp("detail-logform-message").setRawValue("");Ext.getCmp(a.id).load(Ext.getCmp("detail-logform-evid").getValue())})}}]},{id:"evdetail_log",cls:"log-content",hidden:true}]}];Zenoss.DetailPanel.superclass.constructor.apply(this,arguments)},setSummary:function(b){var a=Ext.getCmp("evdetail-summary");a.el.update(b)},setSeverityIcon:function(b){var a=Ext.getCmp("severity-icon");this.clearSeverityIcon();a.addClass(b)},clearSeverityIcon:function(){var a=Ext.getCmp("severity-icon");Ext.each(Zenoss.env.SEVERITIES,function(b){var b=b[1];a.removeClass(b.toLowerCase())})},update:function(h){var j=new Ext.XTemplate.from("detail_table_template");var b=new Ext.XTemplate.from("fullprop_table_template");var d=new Ext.XTemplate.from("log_table_template");var e=Zenoss.util.convertSeverity(h.severity),f=j.applyTemplate(h),a=b.applyTemplate(h),g=d.applyTemplate(h);this.setSummary(h.summary);this.setSeverityIcon(e);Ext.getCmp("evdetail_props").el.update(f);Ext.getCmp("full_event_props").el.update(a);Ext.getCmp("evdetail_log").el.update(g);Ext.getCmp("detail-logform-evid").setValue(h.evid)},wipe:function(){this.clearSeverityIcon();this.setSummary("");Ext.getCmp("show_details").hide();Ext.getCmp("evdetail-log-header").hide();Ext.getCmp("evdetail_log").hide();Ext.getCmp("evdetail_props").hide();Ext.getCmp("full_event_props").hide();Ext.getCmp("log-container").hide()},show:function(){Ext.getCmp("show_details").show();Ext.getCmp("evdetail-log-header").show();Ext.getCmp("evdetail_log").show();Ext.getCmp("evdetail_props").show();if(this.isPropsVisible){Ext.getCmp("full_event_props").show()}Ext.getCmp("log-container").show()},isPropsVisible:false,showProps:function(){el=Ext.getCmp("full_event_props");tgl=Ext.getCmp("show_details");if(!el.hidden){el.hide();this.isPropsVisible=false;tgl.body.update("Show more details...")}else{el.show();this.isPropsVisible=true;tgl.body.update("Hide details")}},popout:function(){var b=Ext.getCmp("detail-logform-evid").getValue(),a=this.isHistory?"viewHistoryDetail":"viewDetail";window.open(a+"?evid="+b,b,"status=1,width=600,height=500")},bind:function(){var b=Ext.getCmp("show_details").getEl(),d=Ext.getCmp("evdetail_tool_close").getEl(),a=Ext.getCmp("evdetail-popout").getEl();b.un("click",this.showProps);b.on("click",this.showProps);d.un("click",this.onDetailHide);d.on("click",this.onDetailHide);a.un("click",this.popout,this);a.on("click",this.popout,this)},load:function(a){Zenoss.remote.EventConsole.detail({evid:a,history:this.isHistory},function(b){var d=b.event[0];this.update(d);this.bind();this.show()},this)}});Ext.reg("detailpanel",Zenoss.DetailPanel);Ext.namespace("Zenoss.util");Zenoss.env.SEVERITIES=[[5,"Critical"],[4,"Error"],[3,"Warning"],[2,"Info"],[1,"Debug"],[0,"Clear"]];Zenoss.util.convertSeverity=function(a){sevs=["clear","debug","info","warning","error","critical"];return sevs[a]};Zenoss.util.convertStatus=function(b){var a=["New","Acknowledged","Suppressed"];return a[b]};Zenoss.util.render_severity=function(a){return'<div class="severity-icon-small '+Zenoss.util.convertSeverity(a)+'"></div>'};Zenoss.util.render_status=function(a){return'<div class="status-icon-small '+a.toLowerCase()+'"></div>'};Zenoss.util.render_linkable=function(e,d,a){var b=a.data[d.id+"_url"];if(b){return'<a href="'+b+'">'+e+"</a>"}else{return e}};Zenoss.util.base64={base64s:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",encode:function(d){if(typeof btoa==="function"){return btoa(d)}var g=this.base64s;var b;var f;var a=0;var e="";while(d.length>=a+3){b=(d.charCodeAt(a++)&255)<<16|(d.charCodeAt(a++)&255)<<8|d.charCodeAt(a++)&255;e+=g.charAt((b&16515072)>>18)+g.charAt((b&258048)>>12)+g.charAt((b&4032)>>6)+g.charAt((b&63))}if(d.length-a>0&&d.length-a<3){f=Boolean(d.length-a-1);b=((d.charCodeAt(a++)&255)<<16)|(f?(d.charCodeAt(a)&255)<<8:0);e+=g.charAt((b&16515072)>>18)+g.charAt((b&258048)>>12)+(f?g.charAt((b&4032)>>6):"=")+"="}return(e)},decode:function(d){if(typeof atob==="function"){return atob(d)}var f=this.base64s;var e;var a="";var b=0;for(;b<d.length;b+=4){e=(f.indexOf(d.charAt(b))&255)<<18|(f.indexOf(d.charAt(b+1))&255)<<12|(f.indexOf(d.charAt(b+2))&255)<<6|f.indexOf(d.charAt(b+3))&255;a+=String.fromCharCode((e&16711680)>>16,(e&65280)>>8,e&255)}if(d.charCodeAt(b-2)==61){return(a.substring(0,a.length-2))}else{if(d.charCodeAt(b-1)==61){return(a.substring(0,a.length-1))}else{return(a)}}}};Ext.namespace("Zenoss.date");Ext.apply(Zenoss.date,{ISO8601Long:"Y-m-d H:i:s",ISO8601Short:"Y-m-d",ShortDate:"n/j/Y",LongDate:"l, F d, Y",FullDateTime:"l, F d, Y g:i:s A",MonthDay:"F d",ShortTime:"g:i A",LongTime:"g:i:s A",SortableDateTime:"Y-m-d\\TH:i:s",UniversalSortableDateTime:"Y-m-d H:i:sO",YearMonth:"F, Y"})});(function(){Ext.ns("Zenoss.i18n");Zenoss.i18n._data={};Zenoss.i18n.translate=function(a,b){t=Zenoss.i18n._data[a];return t?t:(b?b:a)};window._t=Zenoss.i18n.translate})();Ext.ns("Zenoss");Zenoss.HierarchyTreePanel=Ext.extend(Ext.tree.TreePanel,{});Ext.reg("HierarchyTreePanel",Zenoss.HierarchyTreePanel);