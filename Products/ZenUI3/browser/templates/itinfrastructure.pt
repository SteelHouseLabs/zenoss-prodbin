<!--
###########################################################################
#
# This program is part of Zenoss Core, an open source monitoring platform.
# Copyright (C) 2009, Zenoss Inc.
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License version 2 as published by
# the Free Software Foundation.
#
# For complete information please visit: http://www.zenoss.com/oss/
#
###########################################################################
-->

<tal:block metal:use-macro="context/page_macros/base-new">

<tal:block metal:fill-slot="center_panel">
</tal:block>

<tal:block metal:fill-slot="script_layout">
<script>
Ext.onReady(function(){

function updateNavTextWithCount(node) {
    var sel = treesm.getSelectedNode();
    if (sel) {
        var count = sel.attributes.text.count;
        node.setText('<b'+'>Devices ('+count+')<'+'/b>')
    }
}

Zenoss.nav.register({
    DeviceLocation: [{
        id: 'Devices',
        text: 'Devices',
        action: function(node, target) {
            target.layout.setActiveItem('device_grid');
        },
        listeners: {
            render: updateNavTextWithCount
        }
    }, {
        id: 'Map',
        text: 'Map',
        action: function(node, target) {
            target.layout.setActiveItem('map');
        }
    }],
    DeviceClass: [{
        id: 'Devices',
        text: 'Devices',
        action: function(node, target) {
            target.layout.setActiveItem('device_grid');
        },
        listeners: {
            render: updateNavTextWithCount
        }
    },{
        id: 'zprops',
        text: 'Configuration Properties',
        action: function(node, target){
            target.layout.setActiveItem('zprops');
        }
    },{
        id: 'templates',
        text: 'Monitoring Templates',
        action: function(node, target){
            target.layout.setActiveItem('templates');
        }

    }]

});

var treesm = new Ext.tree.DefaultSelectionModel({
    listeners: {
        'selectionchange': function(sm, newnode, oldnode){
            var uid = newnode.attributes.uid;
            Zenoss.util.setContext(uid, 'detail_panel', 'organizer_events');
            var card = Ext.getCmp('master_panel').getComponent(0),
                type = Zenoss.types.type(uid);
            if (type && !Ext.isEmpty(Zenoss.nav[type])) {
                card.navButton.show();
                Ext.getCmp('master_panel').getComponent(1).navButton.show();
            } else {
                card.navButton.hide();
            }
        }
    }
});


function initializeTreeDrop(g) {
    var dz = new Ext.tree.TreeDropZone(g, {
        ddGroup: 'devicegriddd',
        getTargetFromEvent: function(e) {
            return e.getTarget('.x-tree-node-el');
        },
        onNodeOver : function(target, dd, e, data){ 
            // Return the class that makes the check mark
            return Ext.dd.DropZone.prototype.dropAllowed;
        },
        onNodeDrop: function(target, dd, e, data) {
            var nodeid = target.getAttribute('ext:tree-node-id'),
                tree = this.tree,
                targetnode = tree.getNodeById(nodeid),
                targetuid = targetnode.attributes.uid,
                devids = [];
            Ext.each(data.selections, function(r){
                devids.push(r.data.uid);
            });
            Ext.getCmp('device_grid').view.showLoadMask(true);
            Zenoss.remote.DeviceRouter.moveDevices({
                uids: devids,
                target: targetuid
            }, function(data){
                if(data.success) {
                    Ext.getCmp('device_grid').view.nonDisruptiveReset();
                    tree.update(data.tree);
                } else {
                    Ext.getCmp('device_grid').view.showLoadMask(false);
                }
            }, this);
        }
    });
}

var devtree = {
    xtype: 'HierarchyTreePanel',
    id: 'devices',
    searchField: true,
    directFn: Zenoss.remote.DeviceRouter.getTree,
    root: {
        id: 'Devices',
        uid: '/zport/dmd/Devices',
        text: 'Device Classes'
    },
    selModel: treesm,
    listeners: { render: initializeTreeDrop }
};

var grouptree = {
    xtype: 'HierarchyTreePanel',
    id: 'groups',
    searchField: false,
    directFn: Zenoss.remote.DeviceRouter.getTree,
    root: {
        id: 'Groups',
        uid: '/zport/dmd/Groups',
    },
    selectRootOnLoad: false,
    selModel: treesm,
    listeners: { render: initializeTreeDrop }
};

var loctree = {
    xtype: 'HierarchyTreePanel',
    id: 'locs',
    searchField: false,
    directFn: Zenoss.remote.DeviceRouter.getTree,
    root: {
        id: 'Locations',
        uid: '/zport/dmd/Locations',
    },
    selectRootOnLoad: false,
    selModel: treesm,
    listeners: { render: initializeTreeDrop }
};

Ext.getCmp('center_panel').add({
    id: 'center_panel_container',
    layout: 'border',
    defaults: {
        'border': false
    },
    items: [{
        xtype: 'horizontalslide',
        id: 'master_panel',
        text: _t('IT Infrastructure'),
        region: 'west',
        split: true,
        width: 275,
        items: [{
            text: _t('IT Infrastructure'),
            buttonText: _t('Details'),
            items: [devtree, grouptree, loctree],
            autoScroll: true
        },{
            xtype: 'subselection',
            text: _t('Details'),
            target: 'detail_panel',
            buttonText: _t('See All'),
            html: 'some other stuff'
        }],
        listeners: {
            beforecardchange: function(me, card, index, from, fromidx) {
                if (index==1) {
                    var node = treesm.getSelectedNode().attributes;
                    card.setHeaderText(node.text.text);
                } else if (index==0) {
                    Ext.getCmp('subselecttreepanel').getSelectionModel().getSelectedNode().unselect();
                    Ext.getCmp('detail_panel').layout.setActiveItem(0);
                }
            },
            cardchange: function(me, card, index, from , fromidx) {
                if (index==1) {
                    var node = treesm.getSelectedNode().attributes;
                    card.card.setContext(node.uid);
                    // Now, we'll manually preload the iframes on the other
                    // cards. This is extremely temporary.
                    var others = Ext.getCmp('detail_panel').items.items.slice(1);
                    switch (Zenoss.types.type(node.uid)) {
                        case 'DeviceLocation':
                            others[2].setContext(node.uid);
                            break;
                        case 'DeviceClass':
                            var cards = others.slice(0,2);
                            Ext.each(cards, function(c){c.setContext(node.uid)});
                            break;
                    }
                }
            }
        }
    },{
        xtype: 'contextcardpanel',
        id: 'detail_panel',
        region: 'center',
        activeItem: 0,
        split: true,
        items: [{
            xtype: 'DeviceGridPanel',
            ddGroup: 'devicegriddd',
            id: 'device_grid', 
            enableDrag: true,
            tbar: {
                xtype: 'largetoolbar',
                items: [{
                    xtype: 'eventrainbow',
                    id: 'organizer_events'
                }, '-', {
                    id: 'add-button',
                    iconCls: 'add'
                },{
                    id: 'delete-button', 
                    iconCls: 'delete'
                },{
                    id: 'set-button',
                    iconCls: 'set'
                }, {
                    id: 'adddevice-button',
                    iconCls: 'adddevice'
                }, '-', {
                    id: 'import-button',
                    iconCls: 'import'
                },{
                    id: 'export-button',
                    iconCls: 'export'
                },{
                    id: 'configure-button',
                    iconCls: 'configure'
                }]
            }
        }, {
            xtype: 'backcompat',
            viewName: 'zPropertyEdit',
            id: 'zprops'
        }, {
            xtype: 'backcompat',
            viewName: 'perfConfig',
            id: 'templates'
        },{
            xtype: 'contextiframe',
            viewName: 'simpleLocationGeoMap',
            id: 'map'
        }]
    }]
});


});
</script>
</tal:block>
</tal:block> <!-- metal:use-macro="context/page_macros/masterdetailsplit2" -->
