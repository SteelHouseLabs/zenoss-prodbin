#!/usr/bin/env python
import sys
import tempfile
import optparse
import subprocess

import Globals
from Products.ZenUtils.Utils import zenPath
from Products.ZenUtils.GlobalConfig import getGlobalConfiguration

_global_conf = getGlobalConfiguration()
zodb_socket = _global_conf.get('zodb-socket')
if zodb_socket:
    _global_conf['socket-option'] = 'unix_socket %s' % zodb_socket
else:
    _global_conf['socket-option'] = ''

CONFIG = """
<relstorage>
    pack-gc true
    keep-history false
    <mysql>
        host %(zodb-host)s
        port %(zodb-port)s
        db %(zodb-db)s
        user %(zodb-user)s
        passwd %(zodb-password)s
        %(socket-option)s
    </mysql>
</relstorage>
""" % _global_conf

if __name__=="__main__":
    # Get the days option to forward to zodbpack
    parser = optparse.OptionParser(description=__doc__,
        usage="%prog [options]")
    parser.add_option( "-d", "--days", dest="days", default="0",
                      help="Days of history to keep (default 0)")
    options, args = parser.parse_args(sys.argv[1:])

    retcode = 1

    # Write the config file and call zodbpack
    with tempfile.NamedTemporaryFile() as configfile:
        configfile.write(CONFIG)
        configfile.flush()
        cmd = [zenPath('bin', 'zodbpack'), configfile.name, '-d', options.days]
        retcode = subprocess.call(cmd)

    sys.exit(retcode)
