#!/usr/bin/env zendmd

import re
from Products.ZenUtils.ZenDB import ZenDB

with ZenDB('zodb').getConnection() as conn:
   conn.execute('select count(1) from object_state')
   zodbObjectCount = conn.fetchone()[0]

globalCatalogObjectCount = len(dmd.global_catalog)




_BYTES_MAP = {
    'b': 1, 
    'k': 1024,
    'kb': 1024,
    'm': 1024 * 1024,
    'mb': 1024 * 1024,
    'g': 1024 * 1024 * 1024,
    'gb': 1024 * 1024 * 1024,
}

db = dmd.unrestrictedTraverse('/Control_Panel/Database/main')
dbSize = db.db_size()
match = re.search("(?P<value>[0-9]*\.?[0-9]*)(?P<unit>[^0-9]+)", dbSize)
zodbSize = int(float(match.group(1)) * _BYTES_MAP[match.group(2).lower()])


print "zodbObjectCount=%d globalCatalogObjectCount=%d zodbSize=%d " % (zodbObjectCount, globalCatalogObjectCount, zodbSize)
