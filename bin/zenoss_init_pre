#! /usr/bin/env bash

#
# zenoss_init_pre
#
# This script is intended to be run before the zenoss processes have
# been started for the first time.
#
# Note: it is run by root
#

#############################################################################
# This program is part of Zenoss Core, an open source monitoring platform.
# Copyright (C) 2007, Zenoss Inc.
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License version 2 as published by
# the Free Software Foundation.
#
# For complete information please visit: http://www.zenoss.com/oss/
#############################################################################
# environment variable
export OS_USERNAME="**OS_USERNAME**"
export OS_UID="**OS_UID**"
export ZENHOME="**ZENHOME**"
export MYSQLHOST="**MYSQL_HOST**"
export MYSQLZODB="**MYSQL_ZODB**"
export MYSQLPORT="**MYSQL_PORT**"
export MYSQLROOTUSER="**MYSQL_ROOT_USERNAME**"
export MYSQLROOTPASSWD="**MYSQL_ROOT_PASSWD**"
export MYSQLUSER="**MYSQL_USERNAME**"
export MYSQLPASS="**MYSQL_PASSWD**"
export MYSQLZEPDB="**MYSQL_ZEP**"
export RABBITMQ_HOST="**RABBITMQ_HOST**"
export RABBITMQ_SSL="**RABBITMQ_SSL**"
export RABBITMQ_PORT="**RABBITMQ_PORT**"
export RABBITMQ_VHOST="**RABBITMQ_VHOST**"
export RABBITMQ_USER="**RABBITMQ_USER**"
export RABBITMQ_PASS="**RABBITMQ_PASS**"
export ZOPEPASSWORD="**ZOPE_PASSWD**"
export ZOPEHOME="**ZOPEHOME**"
export PYTHON="**PYTHON**"

# load the installation functions
. ${ZENHOME}/bin/shared-functions.sh
. ${ZENHOME}/bin/install-functions.sh

# set the python shebang line
shebang

# create the log directory
mkdir -p ${ZENHOME}/log

# restart external server daemons
restart_snmpd
if [ "${MYSQLHOST}" = "localhost" ];then
   start_mysql
fi
start_rabbitmq

# copy the etc/*.conf.example files to etc/*.conf if etc/*.conf don't
# already exist (we don't want to clobber people's configs)
update_conf_files

# create the database for ZODB
create_zodb_db

# grant database permissions
create_database

# create the ZEP database
create_zep_db

# Update ZEP configuration files
update_zep_cfg

# set up the zope instance
run_mkzopeinstance

# Remediate file ownership under $ZENHOME.
fix_zenhome_owner_and_group ${OS_USERNAME}
run_zenbuild

# Update AMQP configuration files
update_amqp_cfg
configure_amqp
