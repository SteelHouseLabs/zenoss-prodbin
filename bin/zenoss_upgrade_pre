#! /usr/bin/env bash

#
# zenoss_upgrade_pre
#
# This script is intended to be run before the zenoss processes have
# been started for the first time after an upgrade.
#
# Note: it is run by root
#

#############################################################################
# This program is part of Zenoss Core, an open source monitoring platform.
# Copyright (C) 2007, Zenoss Inc.
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License version 2 as published by
# the Free Software Foundation.
#
# For complete information please visit: http://www.zenoss.com/oss/
#############################################################################
# environment variables
export OS_USERNAME="**OS_USERNAME**"
export OS_UID="**OS_UID**"
export ZENHOME="**ZENHOME**"
export MYSQLHOST="**MYSQL_HOST**"
export MYSQLZODB="**MYSQL_ZODB**"
export MYSQLPORT="**MYSQL_PORT**"
export MYSQLROOTUSER="**MYSQL_ROOT_USERNAME**"
export MYSQLROOTPASSWD="**MYSQL_ROOT_PASSWD**"
export MYSQLUSER="**MYSQL_USERNAME**"
export MYSQLPASS="**MYSQL_PASSWD**"
export MYSQLZEPDB="**MYSQL_ZEP**"
export RABBITMQ_HOST="**RABBITMQ_HOST**"
export RABBITMQ_SSL="**RABBITMQ_SSL**"
export RABBITMQ_PORT="**RABBITMQ_PORT**"
export RABBITMQ_VHOST="**RABBITMQ_VHOST**"
export RABBITMQ_USER="**RABBITMQ_USER**"
export RABBITMQ_PASS="**RABBITMQ_PASS**"
export ZOPEPASSWORD="**ZOPE_PASSWD**"
export ZOPEHOME="**ZOPEHOME**"
export PYTHON="**PYTHON**"

# load the installation functions
. ${ZENHOME}/bin/shared-functions.sh
. ${ZENHOME}/bin/install-functions.sh

# Confirm Sun/Oracle flavored jre
confirm_jre

# Test for the pre upgrade zenpack, this should have been removed
# as a part of the 3.x upgrade but if it is present it will cause an error
# on migration, so we need to make sure it is removed.
if ${ZENHOME}/bin/zenpack --list | grep PreUpgrade30 2>/dev/null 1>&2 ;then
    cat <<EOF
    Please remove the PreUpgrade zenpack before continuing.
    You can remove the zenpack with the following command:

EOF

    echo "   " ${ZENHOME} "/bin/zenpack --remove ZenPacks.zenoss.PreUpgrade30 "
    exit 1
fi

# copy the etc/*.conf.example files to etc/*.conf if etc/*.conf don't
# already exist (we don't want to clobber people's configs)
update_conf_files

# version 2.1.1 and below used the system python, but in 2.1.70 we
# started shipping our own.  replace the old scripts with references
# to the new python

if [ "$USE_ZENDS" = "1" ]; then
        REPLACE=${ZENDSHOME}/bin/replace
else
        # replace primitive comes from mysql server package
        REPLACE=/usr/bin/replace
fi

${REPLACE} /usr/bin/python $ZENHOME/bin/python -- $ZENHOME/bin/* 2>/dev/null

${REPLACE} "default-zpublisher-encoding latin-1" \
                 "default-zpublisher-encoding utf-8" -- \
    $ZENHOME/etc/zope.conf

# zenstatus was updated in Avalon to remove the command-line
# option 'configpath'
sed -i -e 's/[ \t]*configpath .*//' $ZENHOME/etc/zenstatus.conf

# set the python shebang to be the proper python
shebang

# restart external server daemons
restart_snmpd
if [ "${MYSQLHOST}" = "localhost" ];then
    start_mysql
fi
start_rabbitmq

# patch any ZenPack code that isn't compatible with this version of core
. ${ZENHOME}/bin/zenoss_upgrade_patch_zenpacks.sh

# create the ZEP database
create_zep_db

# Update ZEP configuration files
update_zep_cfg

MYSQLSOCKET=`mysql --port="${MYSQLPORT}" -h "${MYSQLHOST}" -u "${MYSQLROOTUSER}" --password="${MYSQLROOTPASSWD}" -e "show variables like 'socket'" | grep socket | awk '{print $2}' | head -1`

# Move from ZODB to MySQL
${ZENHOME}/bin/python ${ZENHOME}/bin/changeObjectStore.py \
    --host="$MYSQLHOST" --port="$MYSQLPORT" --passwd="$MYSQLPASS" \
    --user="$MYSQLUSER" --db="$MYSQLZODB" --rootpw="$MYSQLROOTPASSWD" \
    --socket="$MYSQLSOCKET" \
    2>&1 | egrep -v "For help, use ${ZENHOME}/bin/zeoctl -h|Error: no program specified; use -p or -C"


upgrade_relstorage_1_5

# Update AMQP configuration files
update_amqp_cfg
configure_amqp

# migrate the zeo database
run_zenmigrate

