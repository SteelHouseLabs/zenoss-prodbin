#! /usr/bin/env bash

# zenctl        This init.d script starts and stops Zenoss
#               
# description: Zenoss is a monitoring program written by Zenoss, Inc.
#
# Most of the time this script simply delegates to
# ${ZENHOME}/bin/zenoss to actually execute the requested command
# (start/stop).  But, in some situations it behaves differently.  When
# this script encounters the FRESH_INSTALL flag (a file named
# ${ZENHOME}/.fresh_install) the script runs
# ${ZENHOME}/bin/zenoss_init in order to perform first-time
# installation.  When this script encounters the UPGRADED flag (a file
# named ${ZENHOME}/.upgraded) the script runs
# ${ZENHOME}/bin/zenoss_upgrade in order to migrate the zeodb and push
# around the rrd files.
#
# --Christopher Blunck
#

# environment variables
export ZENHOME="**ZENHOME**"
export RUNUSER="**OS_USERNAME**"
export SNMPD_CONF="**SNMPD_CONF**"
export SUDOERS="**SUDOERS**"

# signature of zenoss having been installed for the first time (but
# not configured yet)
export FRESH_INSTALL=${ZENHOME}/.fresh_install

# signature of zenoss having been upgraded from a previous install
export UPGRADED=${ZENHOME}/.upgraded


# changes the owners and permissions for the zenoss files
set_perms() {
    chown -R ${RUNUSER} ${ZENHOME}
    chgrp -R wheel ${ZENHOME}
    chmod -R 775 ${ZENHOME}
}


# these commands are run when zenoss was installed for the first time
fresh_install() {
    echo "Zenoss not initialized.  Performing first-boot initialization..."

    # location of where we copy configuration items to
    ZEN_ETC=${ZENHOME}/etc

    # update the sudoers file
    SUDOERS=/etc/sudoers
    BACKUP=`dirname ${SUDOERS}`/`basename ${SUDOERS}`.orig
    cp ${SUDOERS} ${BACKUP}
    cp ${ZEN_ETC}/sudoers ${SUDOERS}

    # update the snmpd.conf file
    SNMPD_CONF_DIR=`dirname ${SNMPD_CONF}`
    BACKUP=${SNMPD_CONF_DIR}/`basename ${SNMPD_CONF}`.orig
    if [ -f ${SNMPD_CONF} ]; then
        cp ${SNMPD_CONF} ${BACKUP}
    fi
    if [ ! -d ${SNMPD_CONF_DIR} ]; then
        mkdir -p ${SNMPD_CONF_DIR}
    fi
    cp ${ZEN_ETC}/snmpd.conf ${SNMPD_CONF}
    
    # run the first time initialization script
    set_perms
    ${ZENHOME}/bin/zenoss_init
    set_perms

    echo "Zenoss initialization complete."
}


# these commands are run when zenoss is started after being upgraded
upgrade() {
    echo "Zenoss upgraded.  Running data migration scripts..."

    # run the first time initialization script
    set_perms
    ${ZENHOME}/bin/zenoss_upgrade
    set_perms

    echo "Zenoss upgrade complete."
}


#
# main script starts here
#

# run the firstboot if this is the first time zenoss was started
if [ -f ${FRESH_INSTALL} ]; then
    fresh_install
    rm ${FRESH_INSTALL}
fi

# run the upgrade if this is the first time zenoss was started since
# an upgrade occurred
if [ -f ${UPGRADED} ]; then
    upgrade
    rm ${UPGRADED}
fi


# delegate to the main zenoss script for control functions
sudo -u ${RUNUSER} ${ZENHOME}/bin/zenoss $@

